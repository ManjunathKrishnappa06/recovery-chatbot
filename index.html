<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Post-Op Monitoring Agent</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 2em; line-height: 1.6; text-align: center; color: #333; }
    #status { margin: 2em; font-style: italic; color: #555; }
    /* The widget will be created by the script, so no hiding styles are needed */
  </style>
</head>

<body>
  <h1>AI Post-Op Monitoring Agent</h1>
  <p>This is a demonstration of my conversational agent.</p>
  <div id="status">Please share your location to enable all features. The chat will appear once you respond to the permission request.</div>

  <!-- We no longer put the <df-messenger> tag or its script here -->
  <!-- The script below will handle everything. ->

  <!-- ==================================================================== -->
  <!-- === FINAL, OFFICIAL SCRIPT TO PRE-CONFIGURE AND LOAD THE AGENT === -->
  <!-- ==================================================================== -->
  <script>
    // This is the main function that runs when the page loads.
    window.addEventListener('load', function() {
      const statusElement = document.getElementById('status');
      
      // This function will be called AFTER we have the location data.
      // Its only job is to create the configuration and load the main DF script.
      function initializeMessenger(queryParams) {
        console.log("Initializing Dialogflow Messenger with config:", queryParams);

        // --- STEP 1: Define the magic configuration object ---
        window.dfMessengerConfig = {
          agentId: '33519cdf-cd2e-417c-9fa4-de5482015ec5',
          languageCode: 'en',
          chatTitle: 'Post-Op Monitor',
          // Generate a new session ID for a fresh conversation.
          sessionId: Math.random().toString(36).substring(7),
          // Pass our location data (or an empty object) into the config.
          queryParams: queryParams 
        };

        // --- STEP 2: Dynamically create and load the bootstrap script ---
        const script = document.createElement('script');
        script.src = "https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js";
        script.async = true;
        document.body.appendChild(script);

        // --- STEP 3: Update the UI ---
        statusElement.textContent = "Agent is loaded. Please use the chat widget in the bottom right corner.";
      }

      // --- This is where the flow starts: Ask for location ---
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          // SUCCESS Case: We got the location.
          (position) => {
            const lat = position.coords.latitude.toString();
            const lon = position.coords.longitude.toString();
            console.log(`Location success. Lat: ${lat}, Lon: ${lon}`);
            // Prepare the parameters and initialize the messenger.
            initializeMessenger({ user_latitude: lat, user_longitude: lon });
          },
          // ERROR Case: User denied permission.
          (error) => {
            console.error(`Geolocation error: ${error.message}`);
            // Initialize the messenger without location data.
            initializeMessenger({});
          }
        );
      } else {
        // Geolocation is not supported by the browser.
        console.log("Geolocation not supported.");
        initializeMessenger({});
      }
    });
  </script>

</body>
</html>
