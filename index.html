<!-- 1. The Dialogflow Messenger Library -->
<script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>

<!-- 2. The Dialogflow Messenger Element with YOUR details -->
<df-messenger
  project-id="manjunath-vertex-ai"
  agent-id="33519cdf-cd2e-417c-9fa4-de5482015ec5"
  language-code="en">
</df-messenger>

<!-- 3. Our Custom Geolocation Script -->
<script>
  // This script will run after the page loads
  document.addEventListener('df-messenger-loaded', function (event) {
    const dfMessenger = document.querySelector('df-messenger');

    // Listen for the event when the user opens the chat window
    dfMessenger.addEventListener('df-chat-opened', function (event) {
      console.log("Chat window opened. Requesting user location...");

      // Check if the browser has the geolocation feature
      if (navigator.geolocation) {
        // Ask the browser for the current position
        navigator.geolocation.getCurrentPosition(

          // SUCCESS: This function runs if the user clicks "Allow"
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            console.log(`Geolocation successful. Lat: ${lat}, Lng: ${lng}`);

            // This is the most important line:
            // It sends the coordinates to the current Dialogflow session
            // as session parameters named 'latitude' and 'longitude'.
            dfMessenger.set('sessionInfo', {}).set('parameters',
              {
              latitude: lat,
              longitude: lng
            });
          },

          // ERROR: This function runs if the user clicks "Block" or an error occurs
          (error) => {
            console.error("Geolocation failed: ", error.message);
            // Optionally send a parameter to Dialogflow indicating failure
            dfMessenger.setSessionParameters({
              location_permission: 'denied_or_failed'
            });
          }
        );
      } else {
        console.log("Geolocation is not supported by this browser.");
      }
    });
  });
</script>
